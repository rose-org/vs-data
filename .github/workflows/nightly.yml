name: vs-data

on:
  workflow_dispatch:
  schedule:
    # https://crontab.guru/#*/15_*_*_*_*
    - cron: '*/15 * * * *'

jobs:
  build:
    name: Generate vs-data
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      # https://playwright.dev/python/docs/docker
      # https://github.com/microsoft/playwright-python
      matrix:
        dist:
          - {
              os: 'ubuntu',
              symbol: 'noble',
              playwright_ver: '1.55.0',
              playwright_python_ver: '1.55.0'
            }
    container:
      image: mcr.microsoft.com/playwright:v${{ matrix.dist.playwright_ver }}-${{ matrix.dist.symbol }}
      options: -v ${{ github.workspace }}:/worker --cap-add SYS_ADMIN --device /dev/fuse --security-opt apparmor:unconfined
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          repository: rose-org/vpngate-scraper
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0
          ref: main
          path: '.'

      - name: Install Python
        run: |
          apt-get update
          apt-get install -y --no-install-recommends python3 python3-pip python3-venv curl zstd

      - name: Install dependencies
        run: |
          cd /worker
          python3 -m venv .venv
          . .venv/bin/activate
          python3 -m pip install --no-cache-dir playwright==${{ matrix.dist.playwright_python_ver }}
          deactivate

      - name: Build vpn data
        shell: bash
        run: |
          cd /worker
          . .venv/bin/activate
          export HOME=/root
          python3 main.py

      - name: Prepare publish
        shell: bash
        run: |
          echo "TAG_NAME=$(date +%Y%m%d%H%M%S)" >> $GITHUB_ENV
          mkdir /worker/build
          cp /worker/data.json /worker/build
          cp /worker/raw_data.json /worker/build

      - name: Compress
        shell: bash
        run: |
          zstd --rm /worker/build/data.json -o /worker/build/data.json.zst
          zstd --rm /worker/build/raw_data.json -o /worker/build/raw_data.json.zst

      - name: Push to "release" branch
        run: |
          cd /worker/build
          git init
          git config user.name "Epsilon"
          git config user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"
          git checkout -b release
          git add .
          git commit -m "${{ env.TAG_NAME }}"
          git remote add origin "https://${{ github.actor }}:${{ github.token }}@github.com/${{ github.repository }}"
          git push -f origin release

  mirror:
    name: Get raw csv
    runs-on: ubuntu-latest
    steps:
      - name: Download raw csv
        shell: bash
        run: |
          echo "TAG_NAME=$(date +%Y%m%d%H%M%S)" >> $GITHUB_ENV
          mkdir -p ${{ github.workspace }}/upload
          curl -sL --connect-timeout 10 --retry 5 --retry-delay 5 --retry-max-time 25 -o ${{ github.workspace }}/upload/raw_data.csv "https://www.vpngate.net/api/iphone/"

      - name: Compress
        shell: bash
        run: |
          zstd --rm ${{ github.workspace }}/upload/raw_data.csv -o ${{ github.workspace }}/upload/raw_data.csv.zst

      - name: Push to "mirror" branch
        run: |
          cd ${{ github.workspace }}/upload
          git init
          git config user.name "Epsilon"
          git config user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"
          git checkout -b mirror
          git add .
          git commit -m "${{ env.TAG_NAME }}"
          git remote add origin "https://${{ github.actor }}:${{ github.token }}@github.com/${{ github.repository }}"
          git push -f origin mirror

  cleanup:
    name: Cleanup
    runs-on: ubuntu-latest
    steps:
      - name: Remove old Workflow runs records
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 3
          keep_minimum_runs: 3
